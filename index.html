<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Medicamentos - Archivos Locales</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-card: white;
            --bg-header: #2c3e50;
            --bg-nav: #ecf0f1;
            --bg-nav-active: white;
            --text-primary: #495057;
            --text-secondary: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #bdc3c7;
            --border-light: #ecf0f1;
            --accent-primary: #3498db;
            --accent-secondary: #34495e;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #2d2d2d;
            --bg-header: #1e1e1e;
            --bg-nav: #333333;
            --bg-nav-active: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #ffffff;
            --text-light: #b0b0b0;
            --border-color: #404040;
            --border-light: #404040;
            --accent-primary: #4fa8d8;
            --accent-secondary: #5a6c7d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            min-height: calc(100vh - 20px);
            transition: all 0.3s ease;
        }

        .header {
            background-color: var(--bg-header);
            color: white;
            padding: 10px;
            text-align: center;
            position: relative;
        }

        .data-status {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-local {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .status-external {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .status-unsaved {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            opacity: 0.9;
        }

        .header .hospital-name {
            font-size: clamp(0.8rem, 1.8vw, 1rem);
            margin-top: 8px;
            padding: 8px 16px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 20px;
            display: inline-block;
        }

        .hospital-logo {
            max-height: 40px;
            max-width: 150px;
            object-fit: contain;
            margin-right: 10px;
            vertical-align: middle;
        }

        .nav-tabs {
            display: flex;
            background: var(--bg-nav);
            overflow-x: auto;
            border-bottom: 2px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            background-color: transparent;
        }

        .nav-tab:hover {
            background-color: var(--border-light);
            color: var(--accent-primary);
        }

        .nav-tab.active {
            background-color: var(--bg-nav-active);
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .card-header {
            background-color: var(--accent-secondary);
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .card-body {
            padding: 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 14px;
            margin: 2px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #e67e22;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #7f8c8d;
        }

        .file-section {
            background-color: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-section.dragover {
            border-color: var(--accent-primary);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .file-section.loaded {
            border-color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
            border-style: solid;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background-color: var(--bg-card);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            line-height: 1.5;
        }

        .alert-info {
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            color: var(--text-secondary);
        }

        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid #27ae60;
            color: var(--text-secondary);
        }

        .alert-warning {
            background-color: rgba(243, 156, 18, 0.1);
            border-left: 4px solid #f39c12;
            color: var(--text-secondary);
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            color: var(--text-secondary);
        }

        .medications-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .medications-table th {
            background-color: var(--accent-secondary);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .medications-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: top;
            color: var(--text-primary);
        }

        .medications-table tbody tr:hover {
            background-color: var(--border-light);
        }

        .medications-table .medication-name-cell {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .medications-table .group-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }

        .group-inmunosupresores {
            background-color: #e67e22;
        }

        .group-antiinfecciosos {
            background-color: #27ae60;
        }

        .group-otros {
            background-color: #5da4eb;
        }

        .medications-table .actions-cell {
            white-space: nowrap;
        }

        .medications-table .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 10px;
        }

        .stat-card {
            background-color: #e1eaf3;
            color: #2c3e50;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 3px;
            line-height: 1.1;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(39, 174, 96, 0.9);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        .medication-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .medication-card {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            transition: all 0.3s ease;
            border-left: 4px solid var(--accent-primary);
            border: 1px solid var(--border-light);
        }

        .medication-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .medication-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .medication-group {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .medication-details {
            margin: 15px 0;
        }

        .detail-item {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-content {
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.5;
        }

        .medication-images {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .med-image-envase {
            width: 160px;  /* M√°s ancha para el envase */
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border-color);
        }

        .med-image-forma {
            width: 80px;   /* Cuadrada para la forma farmac√©utica */
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border-color);
        }

        .med-image-report {
            width: 160px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            margin-right: 10px;
        }

        .medication-images-report {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .important-info {
            background-color: rgba(230, 126, 34, 0.1);
            border-left: 4px solid #e67e22;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .important-info .label {
            font-weight: 700;
            color: #d35400;
            display: block;
            margin-bottom: 8px;
        }

        /* Estilos para Planning Horario */
        .planning-container {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border-light);
        }

        .planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-light);
        }

        .patient-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .patient-name-input {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            min-width: 200px;
            background-color: var(--bg-card);
            color: var(--text-primary);
        }

        .current-date {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .time-schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .time-header {
            background: linear-gradient(135deg, var(--accent-secondary), var(--bg-header));
            color: white;
            height: 60px;
        }

        .time-header th {
            padding: 10px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            border-right: 1px solid rgba(255,255,255,0.2);
            position: relative;
        }

        .time-icons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }

        .time-icon {
            font-size: 1.2rem;
        }

        .hour-number {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .medication-row {
            border-bottom: 2px solid var(--border-light);
        }

        .medication-info {
            background: var(--bg-primary);
            border-right: 2px solid var(--border-light);
            padding: 15px;
            width: 250px;
            vertical-align: top;
        }

        .med-image-planning {
            width: 120px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            margin-bottom: 10px;
        }

        .med-name-planning {
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .med-planning-text {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .hour-cell {
            text-align: center;
            padding: 10px 5px;
            border-right: 1px solid var(--border-light);
            vertical-align: middle;
            position: relative;
            width: 40px;
        }

        .dose-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 80px;
            justify-content: center;
        }

        .dose-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transform: scale(1.2);
        }

        .dose-input {
            width: 35px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 2px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .dose-input:disabled {
            background: var(--bg-primary);
            color: var(--text-light);
        }

        .dose-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(52,152,219,0.1);
        }

        .pill-icon {
            font-size: 1.2rem;
            color: var(--accent-primary);
        }

        .morning-bg { background: linear-gradient(135deg, #fff9e6, #fef5d3); }
        .noon-bg { background: linear-gradient(135deg, #fff3cd, #ffeaa7); }
        .evening-bg { background: linear-gradient(135deg, #e8f4fd, #d1ecf1); }
        .night-bg { background: linear-gradient(135deg, #e8e9f3, #d6d8e7); }

        .planning-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .report-container {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .checkbox-card {
            border: 2px solid var(--border-light);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--bg-card);
        }

        .checkbox-card:hover {
            border-color: var(--accent-primary);
            background-color: rgba(52,152,219,0.05);
        }

        .checkbox-card.selected {
            border-color: #27ae60;
            background-color: rgba(39,174,96,0.05);
        }

        .checkbox-card input[type="checkbox"] {
            margin-right: 10px;
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: var(--bg-card);
            color: var(--text-primary);
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(52,152,219,0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--accent-secondary);
            color: white;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            background-color: var(--bg-primary);
        }

        .image-upload-area:hover {
            border-color: var(--accent-primary);
            background-color: rgba(52,152,219,0.1);
        }

        .image-upload-area.has-image {
            border-style: solid;
            border-color: #27ae60;
            background-color: rgba(39,174,96,0.1);
        }

        .uploaded-image {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-top: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 8px;
                min-height: calc(100vh - 10px);
            }

            .header {
                padding: 15px;
            }

            .data-status,
            .theme-toggle {
                position: static;
                margin: 5px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                min-width: auto;
                flex: none;
            }

            .content {
                padding: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            .medications-table {
                font-size: 12px;
            }

            .medications-table th,
            .medications-table td {
                padding: 8px 6px;
            }

            .medications-table .btn-sm {
                padding: 4px 8px;
                font-size: 11px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .medication-grid {
                grid-template-columns: 1fr;
            }

            .medication-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            /* Planning responsive */
            .planning-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .patient-name-input {
                min-width: 100%;
            }

            .time-schedule-table {
                font-size: 11px;
            }

            .medication-info {
                width: 200px;
                padding: 10px;
            }

            .med-image-planning {
                width: 40px;
                height: 40px;
            }

            .med-planning-text {
                font-size: 0.75rem;
                min-height: 40px;
            }

            .hour-cell {
                padding: 5px 2px;
                width: 30px;
            }

            .dose-container {
                min-height: 60px;
                gap: 5px;
            }

            .dose-checkbox {
                transform: scale(1);
            }

            .dose-input {
                width: 25px;
                font-size: 0.7rem;
            }

            .time-header th {
                padding: 8px 3px;
                font-size: 0.8rem;
            }

            .hour-number {
                font-size: 0.9rem;
            }

            .time-icon {
                font-size: 1rem;
            }

            .planning-actions {
                flex-direction: column;
                align-items: center;
            }

            .planning-actions .btn {
                width: 100%;
                max-width: 300px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .medication-card {
                padding: 15px;
            }

            .btn {
                font-size: 11px;
                padding: 6px 10px;
            }

            .form-control {
                padding: 10px;
            }

            .search-input {
                padding: 10px 40px 10px 12px;
                font-size: 14px;
            }

            .auto-save-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="data-status" id="dataStatus">
                <span>üíæ</span>
                Base de datos local
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô Modo Nocturno</button>
            <h1>InfoMed 2.0</h1>
            <p>Informaci√≥n de medicamentos para pacientes</p>
            <div class="hospital-name" id="hospitalHeader">
                <span id="hospitalDisplayName">Hospital no configurado</span>
            </div>
        </header>

        <nav class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">üè† Inicio</div>
            <div class="nav-tab" data-tab="repositorio">üìö Tratamiento</div>
            <div class="nav-tab" data-tab="informacion">üìã Informaci√≥n</div>
            <div class="nav-tab" data-tab="planning">üìÖ Calendario</div>
            <div class="nav-tab" data-tab="informe">üìÑ Informe</div>
            <div class="nav-tab" data-tab="gestion">üíä BD Medicamentos</div>
            <div class="nav-tab" data-tab="archivos">üîß Ajustes</div>
        </nav>

        <!-- GESTI√ìN DE ARCHIVOS -->
        <section id="archivos" class="content">
            <div class="card">
                <div class="card-header">Gesti√≥n de archivos de datos</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            La aplicaci√≥n funciona mediante un <strong>sistema de archivos locales</strong>:<br>
                            ‚Ä¢ Los datos se guardan localmente en el navegador de forma autom√°tica. Mientras se utilice el mismo navegador, los datos (base de datos de medicamentos y configuraci√≥n del hospital) estar√°n disponibles<br>
                            ‚Ä¢ Puedes importar archivos (formato JSON) para cargar datos (base de datos de medicamentos y configuraci√≥n del hospital)<br>
                              Importante: al importar un archivo, se sustituye completamente la informaci√≥n almacenada localmente (no se a√±aden datos, se sustituyen)<br>
                            ‚Ä¢ Puedes exportar archivos (formato JSON) para hacer copias de seguridad<br>
                            ‚Ä¢ Con la opci√≥n "Limpiar datos" se elimina toda la informaci√≥n almacenada en el navegador. Recuerda hacer una copia de seguridad antes si quieres conservarla<br>
                            ‚Ä¢ Con la opci√≥n "Descargar plantilla" puedes obtener un archivo con la estructura de la base de datos de medicamentos y de la informaci√≥n del hospital. Se puede utilizar para hacer una carga de datos externa e importarla posteriormente<br>                            
                        </div>
                    </div>

                    <div class="file-section" id="dropZone">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--text-secondary); margin-bottom: 10px;">üì• Cargar Base de Datos</h3>
                            <p style="color: var(--text-light); margin-bottom: 15px;">
                                Arrastra un archivo JSON aqu√≠ o haz clic para seleccionar
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                üìÇ Seleccionar archivo JSON
                            </button>
                        </div>
                        
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="cargarArchivo(event)">
                        
                        <div id="fileInfo" style="margin-top: 15px; display: none;">
                            <div class="alert alert-success">
                                <span>‚úÖ</span>
                                <div id="fileInfoContent"></div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                        <button class="btn btn-warning" onclick="exportarBaseDatos()" id="btnExportar">
                            üì§ Exportar Base de Datos
                        </button>
                        <button class="btn btn-secondary" onclick="limpiarBaseDatos()">
                            üóëÔ∏è Limpiar Datos
                        </button>
                        <button class="btn btn-primary" onclick="descargarPlantillaJSON()">
                            üìã Descargar Plantilla
                        </button><br>
                        <p></p>
                        <button class="btn btn-success" onclick="mostrarEstadisticas()">
                            üìä Ver Estad√≠sticas
                        </button>
                    </div>

                    <div id="estadisticasDB" style="display: none; margin-top: 20px;">
                        <!-- Las estad√≠sticas se mostrar√°n aqu√≠ -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Configuraci√≥n del Hospital</div>
                <div class="card-body">
                    <form id="formHospital">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Nombre del Hospital</label>
                                <input type="text" class="form-control" id="hospitalNombre" placeholder="Ej: Hospital Universitario La Fe">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Direcci√≥n</label>
                                <input type="text" class="form-control" id="hospitalDireccion" placeholder="Ej: Av. Fernando Abril Martorell, 106">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-control" id="hospitalTelefono" placeholder="Ej: +34 961 244 000">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Correo Electr√≥nico</label>
                                <input type="email" class="form-control" id="hospitalEmail" placeholder="Ej: info@hospital.es">
                            </div>
                            <div class="form-group">
                                <label class="form-label">P√°gina Web</label>
                                <input type="url" class="form-control" id="hospitalWeb" placeholder="Ej: https://www.hospital.es">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Logo del Hospital/Servicio (opcional)</label>
                                <div class="image-upload-area" onclick="document.getElementById('hospitalLogo').click()">
                                    <p>üè• Haz clic para seleccionar logo</p>
                                    <input type="file" id="hospitalLogo" accept="image/*" style="display: none;" onchange="previewImage(this, 'previewLogo')">
                                    <img id="previewLogo" class="uploaded-image" style="display: none;">
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-success">
                                üíæ Guardar Datos del Hospital
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- DASHBOARD -->
        <section id="dashboard" class="content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalMedicamentos">0</div>
                    <div class="stat-label">Total medicamentos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="gruposPrincipales">0</div>
                    <div class="stat-label">Grupos farmacol√≥gicos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ultimaDescarga">--</div>
                    <div class="stat-label">√öltima descarga</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Inicio</div>
                <div class="card-body">
                    <p>Bienvenido a <strong>InfoMed 2.0</strong>, programa de informaci√≥n de medicamentos a pacientes.</p>
                    <p>-----------------------------</p>
                    <p>Caracter√≠sticas principales</p>
                    <p>-----------------------------</p>
                    <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>üíæ Autoguardado inteligente:</strong> los datos se guardan autom√°ticamente en tu navegador</li>
                        <li><strong>üìÅ Gesti√≥n de archivos:</strong> importa y exporta bases de datos en formato JSON</li>
                        <li><strong>üîÑ Copias de seguridad:</strong> exporta tus datos regularmente para mayor seguridad</li>
                        <li><strong>üë• Multi-usuario</strong></li>
                        <li><strong>‚ö° Ejecuci√≥n local:</strong> funciona directamente con cualquier navegador</li>
                        <li><strong>üñºÔ∏è Gesti√≥n de im√°genes:</strong> almacenamiento optimizado con compresi√≥n autom√°tica</li>
                    </ul>

                    <div class="alert alert-warning">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>Importante:</strong> los datos (repositorio de medicamentos y datos del hospital) se almacenan localmente en tu navegador. Recuerda exportar regularmente tu base de datos para crear copias de seguridad. Si se ejecuta en un navegador diferente o en otro ordenador, recuerda cargar la copia de seguridad de tus datos para disponer de toda la informaci√≥n
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 12px; color: var(--text-light); margin-top: 20px;">
                        ¬©Ô∏è <a href="https://www.linkedin.com/in/emilio-monte-boquet" target="_blank" style="color: var(--accent-primary); text-decoration: none;">Emilio Monte Boquet</a> - 2025
                    </div>
                    <div style="text-align: center; font-size: 12px; color: var(--text-light); margin-top: 8px;">
                        Esta aplicaci√≥n es de uso libre, pero requiere una autorizaci√≥n previa por parte del autor para poder acceder y utilizarla. 
                    </div>
                    <div style="text-align: center; font-size: 12px; color: var(--text-light); margin-top: 3px;">
                        Contacta con el autor en caso de detectar alg√∫n error en la aplicaci√≥n o si tienes alguna sugerencia de mejora. 
                    </div>
                </div>
            </div>
        </section>

        <!-- GESTI√ìN -->
        <section id="gestion" class="content">
            <div class="card">
                <div class="card-header">Gesti√≥n de la base de datos de medicamentos</div>
                <div class="card-body">
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-primary" onclick="abrirModalMedicamento()">
                            ‚ûï A√±adir Medicamento
                        </button>
                        <button class="btn btn-success" onclick="exportarBaseDatos()">
                            üì• Exportar Base de Datos
                        </button>
                        <button class="btn btn-warning" onclick="document.getElementById('fileInput').click()">
                            üì§ Importar Base de Datos
                        </button>
                    </div>

                    <div class="search-bar">
                        <input type="text" class="search-input" id="busquedaGestion" placeholder="Buscar medicamentos (nombre comercial, principio activo o grupo farmacol√≥gico)..." oninput="filtrarMedicamentosGestion()">
                        <span class="search-icon">üîç</span>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="medications-table" id="tablaMedicamentosGestion">
                            <thead>
                                <tr>
                                    <th>Medicamento</th>
                                    <th>Principio Activo</th>
                                    <th>Grupo</th>
                                    <th>Lugar Dispensaci√≥n</th>
                                    <th>√öltima Modificaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los medicamentos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- REPOSITORIO -->
        <section id="repositorio" class="content">
            <div class="card">
                <div class="card-header">Selecci√≥n de los medicamentos</div>
                <div class="card-body">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="busquedaRepo" placeholder="Buscar medicamentos (nombre comercial, principio activo o grupo farmacol√≥gico)..." oninput="filtrarRepositorio()">
                        <span class="search-icon">üîç</span>
                    </div>

                    <div id="repositorioMedicamentos">
                        <!-- Los medicamentos se cargar√°n din√°micamente -->
                    </div>
                </div>
            </div>
        </section>

        <!-- INFORMACI√ìN PARA PACIENTES -->
        <section id="informacion" class="content">
            <div class="card">
                <div class="card-header">Informaci√≥n</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <span>‚ÑπÔ∏è</span>
                        <div>
                            <strong>Medicamentos seleccionados para el paciente:</strong><br>
                            La informaci√≥n mostrada corresponde a los medicamentos seleccionados en la pesta√±a "Tratamiento". Solo se puede modificar desde la pesta√±a "BD Medicamentos".<br>
                            Los medicamentos se encuentran agrupados por grupo farmacol√≥gico.
                        </div>
                    </div>
                    <div id="informacionPacientes">
                        <!-- La informaci√≥n se cargar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </section>

        <!-- PLANNING HORARIO -->
        <section id="planning" class="content">
            <div class="card">
                <div class="card-header">Planificaci√≥n horaria del tratamiento</div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <span>‚è∞</span>
                        <div>
                            <strong>Planificaci√≥n horaria personalizada:</strong><br>
                            Configure los horarios de administraci√≥n de los medicamentos seleccionados. Para ello, marque las casillas correspondientes y especifique la cantidad de unidades que se debe administrar el paciente (es 1 por defecto).<br>
                            Si lo considera necesario, puede a√±adir instrucciones espec√≠ficas para su paciente en cada medicamento (se mostrar√°n en el informe del paciente.)
                        </div>
                    </div>
                    
                    <div class="planning-container">
                        <div class="planning-header">
                            <div class="patient-info">
                                <label style="font-weight: 600; color: var(--text-secondary);">üë§ Paciente:</label>
                                <input type="text" class="patient-name-input" id="planningPatientName" placeholder="Nombre del paciente">
                            </div>
                            <div class="current-date">
                                üìÖ Fecha: <span id="planningDate"></span>
                            </div>
                        </div>
                        
                        <div id="planningSchedule">
                            <!-- El planning se cargar√° din√°micamente -->
                        </div>
                        
                        <div class="planning-actions">
                            <button class="btn btn-primary" onclick="guardarPlanning()">üíæ Guardar Planning</button>
                            <button class="btn btn-secondary" onclick="limpiarPlanning()">üóëÔ∏è Limpiar Horarios</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- INFORME -->
        <section id="informe" class="content">
            <div class="card">
                <div class="card-header">Generar Informe</div>
                <div class="card-body">
                    <div style="display: flex; justify-content: left; margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="exportarPDF()">
                            üìÑ Exportar a PDF
                        </button>
                    </div>
                    
                    <div id="contenidoInforme" class="report-container">
                        <div class="report-header" style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border-light);">
                            <h2 style="color: var(--text-secondary); margin-bottom: 10px;">InfoMed 2.0: informaci√≥n de medicamentos</h2>
                            <div id="hospitalInfoInforme">
                                <!-- Datos del hospital se cargar√°n aqu√≠ -->
                            </div>
                            <p style="color: var(--text-light);"><strong>Fecha:</strong> <span id="fechaInforme"></span></p>
                        </div>
                        <div id="reporteMedicamentos">
                            <!-- El contenido del informe se cargar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL PARA A√ëADIR/EDITAR MEDICAMENTO -->
    <div id="modalMedicamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">A√±adir Medicamento</h3>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formMedicamento">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nombre del medicamento</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Principio activo</label>
                            <input type="text" class="form-control" id="principioActivo" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grupo farmacol√≥gico</label>
                            <input type="text" class="form-control" id="grupo" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Actividad farmacol√≥gica</label>
                            <input type="text" class="form-control" id="actividadFarmacologica" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Forma de administraci√≥n</label>
                        <textarea class="form-control" id="formaAdministracion" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Forma de conservaci√≥n</label>
                        <textarea class="form-control" id="formaConservacion" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lugar de dispensaci√≥n</label>
                        <select class="form-control" id="lugarDispensacion" required>
                            <option value="">Seleccionar...</option>
                            <option value="Farmacia Comunitaria">Farmacia Comunitaria</option>
                            <option value="Farmacia Hospitalaria">Farmacia Hospitalaria</option>
                            <option value="Ambas">Ambas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Informaci√≥n importante (opcional)</label>
                        <textarea class="form-control" id="informacionImportante"></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Imagen del envase</label>
                            <div class="image-upload-area" onclick="document.getElementById('imagenEnvase').click()">
                                <p>üñºÔ∏è Haz clic para seleccionar imagen</p>
                                <input type="file" id="imagenEnvase" accept="image/*" style="display: none;" onchange="previewImage(this, 'previewEnvase')">
                                <img id="previewEnvase" class="uploaded-image" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Imagen forma farmac√©utica</label>
                            <div class="image-upload-area" onclick="document.getElementById('imagenForma').click()">
                                <p>üíä Haz clic para seleccionar imagen</p>
                                <input type="file" id="imagenForma" accept="image/*" style="display: none;" onchange="previewImage(this, 'previewForma')">
                                <img id="previewForma" class="uploaded-image" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                        <button type="submit" class="btn btn-success">Guardar Medicamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL PARA NOMBRE DEL PACIENTE -->
    <div id="modalPaciente" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">üë§ Datos del Paciente</h3>
                <button class="modal-close" onclick="cerrarModalPaciente()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre del paciente (opcional)</label>
                    <input type="text" class="form-control" id="nombrePaciente" placeholder="Ingrese el nombre del paciente">
                    <small style="color: var(--text-light); margin-top: 5px; display: block;">
                        Este nombre aparecer√° en el informe PDF. Puede dejarlo vac√≠o si no desea incluirlo.
                    </small>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalPaciente()">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="confirmarGenerarPDF()">üìÑ Generar PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- INDICADOR DE AUTOGUARDADO -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        ‚úÖ Guardado autom√°ticamente
    </div>

    <script>
        // Variables globales
        let medicamentos = [];
        let medicamentosSeleccionados = [];
        let datosHospital = {};
        let editandoId = null;
        let baseDatosRuta = null;
        let autoSaveTimeout = null;
        let nombrePacienteActual = '';
        let planningData = {}; // Para almacenar los horarios seleccionados
        let planningTexts = {}; // Para almacenar los textos de planning editables

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosLocales();
            inicializarEventos();
            inicializarDragAndDrop();
            actualizarEstadoBaseDatos();
            cargarTemaGuardado();
        });

        function inicializarEventos() {
            // Event listeners para las pesta√±as
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    cambiarPestana(this.dataset.tab);
                });
            });

            // Event listeners para formularios
            document.getElementById('formHospital').addEventListener('submit', guardarDatosHospital);
            document.getElementById('formMedicamento').addEventListener('submit', guardarMedicamento);

            // Autoguardado cuando se modifica cualquier dato
            document.addEventListener('input', debounceAutoSave);
            document.addEventListener('change', debounceAutoSave);
        }

        function inicializarDragAndDrop() {
            const dropZone = document.getElementById('dropZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });

            dropZone.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    procesarArchivoArrastrado(files[0]);
                }
            }, false);
        }

        function debounceAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoGuardar, 1000); // Guardar despu√©s de 1 segundo de inactividad
        }

        function autoGuardar() {
            guardarDatosLocales();
            mostrarIndicadorAutoguardado();
        }

        function mostrarIndicadorAutoguardado() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Gesti√≥n de datos locales
        function cargarDatosLocales() {
            try {
                // Cargar medicamentos
                const medicamentosData = localStorage.getItem('medicamentosDB_local');
                if (medicamentosData) {
                    medicamentos = JSON.parse(medicamentosData);
                }

                // Cargar selecci√≥n
                const seleccionData = localStorage.getItem('medicamentosSeleccionados_local');
                if (seleccionData) {
                    medicamentosSeleccionados = JSON.parse(seleccionData);
                }

                // Cargar datos del hospital
                const hospitalData = localStorage.getItem('datosHospital_local');
                if (hospitalData) {
                    datosHospital = JSON.parse(hospitalData);
                    cargarDatosHospitalForm();
                    actualizarDisplayHospital();
                }

                // Cargar planning data
                const planningDataGuardado = localStorage.getItem('planningData_local');
                if (planningDataGuardado) {
                    planningData = JSON.parse(planningDataGuardado);
                }

                // Cargar planning texts
                const planningTextsGuardado = localStorage.getItem('planningTexts_local');
                if (planningTextsGuardado) {
                    planningTexts = JSON.parse(planningTextsGuardado);
                }

                // Cargar nombre paciente
                const nombrePacienteGuardado = localStorage.getItem('nombrePaciente_local');
                if (nombrePacienteGuardado) {
                    nombrePacienteActual = nombrePacienteGuardado;
                }

                // Actualizar UI
                actualizarDashboard();
                mostrarMedicamentosGestion();
                mostrarRepositorio();
                actualizarUltimaDescarga();

            } catch (error) {
                console.error('Error cargando datos locales:', error);
                // Si hay error, inicializar con datos vac√≠os
                medicamentos = [];
                medicamentosSeleccionados = [];
                datosHospital = {};
                planningData = {};
                planningTexts = {};
                nombrePacienteActual = '';
            }
        }

        function guardarDatosLocales() {
            try {
                localStorage.setItem('medicamentosDB_local', JSON.stringify(medicamentos));
                localStorage.setItem('medicamentosSeleccionados_local', JSON.stringify(medicamentosSeleccionados));
                localStorage.setItem('datosHospital_local', JSON.stringify(datosHospital));
                localStorage.setItem('planningData_local', JSON.stringify(planningData));
                localStorage.setItem('planningTexts_local', JSON.stringify(planningTexts));
                localStorage.setItem('nombrePaciente_local', nombrePacienteActual);
                localStorage.setItem('ultimoGuardado_local', new Date().toISOString());
                
                actualizarEstadoBaseDatos();
            } catch (error) {
                console.error('Error guardando datos locales:', error);
                alert('Error al guardar los datos. Verifica el espacio disponible.');
            }
        }

        // Gesti√≥n de archivos externos
        function cargarArchivo(event) {
            const file = event.target.files[0];
            if (file) {
                procesarArchivoArrastrado(file);
            }
        }

        function procesarArchivoArrastrado(file) {
            if (!file.name.endsWith('.json')) {
                alert('Solo se aceptan archivos JSON');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    
                    if (validarEstructuraBaseDatos(datos)) {
                        if (confirm('¬øDeseas cargar esta base de datos? Se reemplazar√°n los datos actuales.')) {
                            cargarBaseDatosDesdeArchivo(datos, file.name);
                        }
                    } else {
                        alert('El archivo no tiene la estructura correcta de base de datos');
                    }
                } catch (error) {
                    alert('Error al leer el archivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function validarEstructuraBaseDatos(datos) {
            return (
                datos &&
                Array.isArray(datos.medicamentos) &&
                Array.isArray(datos.medicamentosSeleccionados) &&
                typeof datos.datosHospital === 'object'
            );
        }

        function cargarBaseDatosDesdeArchivo(datos, nombreArchivo) {
            try {
                medicamentos = datos.medicamentos || [];
                medicamentosSeleccionados = datos.medicamentosSeleccionados || [];
                datosHospital = datos.datosHospital || {};
                planningData = datos.planningData || {};
                planningTexts = datos.planningTexts || {};
                nombrePacienteActual = datos.nombrePaciente || '';

                // Guardar en localStorage
                guardarDatosLocales();

                // Actualizar UI
                cargarDatosHospitalForm();
                actualizarDisplayHospital();
                actualizarDashboard();
                mostrarMedicamentosGestion();
                mostrarRepositorio();
                actualizarUltimaDescarga();

                // Mostrar informaci√≥n del archivo cargado
                mostrarInfoArchivoCargado(datos, nombreArchivo);
                
                // Actualizar estado
                baseDatosRuta = nombreArchivo;
                actualizarEstadoBaseDatos('external');

                alert('‚úÖ Base de datos cargada correctamente desde ' + nombreArchivo);

            } catch (error) {
                console.error('Error cargando base de datos:', error);
                alert('Error al cargar la base de datos: ' + error.message);
            }
        }

        function mostrarInfoArchivoCargado(datos, nombreArchivo) {
            const infoDiv = document.getElementById('fileInfo');
            const contentDiv = document.getElementById('fileInfoContent');
            
            const fechaCarga = new Date().toLocaleString('es-ES');
            
            contentDiv.innerHTML = `
                <strong>Archivo cargado:</strong> ${nombreArchivo}<br>
                <strong>Fecha de carga:</strong> ${fechaCarga}<br>
                <strong>Medicamentos:</strong> ${datos.medicamentos?.length || 0}<br>
                <strong>Medicamentos seleccionados:</strong> ${datos.medicamentosSeleccionados?.length || 0}<br>
                <strong>Hospital configurado:</strong> ${datos.datosHospital?.nombre || 'No'}
            `;
            
            infoDiv.style.display = 'block';
            document.getElementById('dropZone').classList.add('loaded');
        }

        function exportarBaseDatos() {
            try {
                const datosExportar = {
                    version: "1.0",
                    fechaExportacion: new Date().toISOString(),
                    medicamentos: medicamentos,
                    medicamentosSeleccionados: medicamentosSeleccionados,
                    datosHospital: datosHospital,
                    planningData: planningData,
                    planningTexts: planningTexts,
                    nombrePaciente: nombrePacienteActual,
                    estadisticas: {
                        totalMedicamentos: medicamentos.length,
                        gruposFarmacologicos: [...new Set(medicamentos.map(med => med.grupo))].length,
                        medicamentosConImagenes: medicamentos.filter(med => med.imagenEnvase || med.imagenForma).length
                    }
                };

                const blob = new Blob([JSON.stringify(datosExportar, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const fecha = new Date().toISOString().split('T')[0];
                const nombreHospital = datosHospital.nombre ? datosHospital.nombre.replace(/\s+/g, '_') : 'Hospital';
                
                a.href = url;
                a.download = `medicamentos_${nombreHospital}_${fecha}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Guardar fecha de √∫ltima descarga
                localStorage.setItem('ultimaDescarga_local', new Date().toISOString());
                actualizarUltimaDescarga();

                alert('‚úÖ Base de datos exportada correctamente');

            } catch (error) {
                console.error('Error exportando base de datos:', error);
                alert('Error al exportar la base de datos: ' + error.message);
            }
        }

        function descargarPlantillaJSON() {
            const plantilla = {
                version: "1.0",
                descripcion: "Plantilla para base de datos de medicamentos",
                medicamentos: [
                    {
                        id: "ejemplo_1",
                        nombre: "Nombre del medicamento",
                        principioActivo: "Principio activo",
                        grupo: "Grupo farmacol√≥gico",
                        actividadFarmacologica: "Descripci√≥n de la actividad",
                        formaAdministracion: "C√≥mo se administra",
                        formaConservacion: "C√≥mo se conserva",
                        lugarDispensacion: "Farmacia Comunitaria / Farmacia Hospitalaria / Ambas",
                        informacionImportante: "Informaci√≥n relevante para el paciente",
                        fechaCreacion: new Date().toISOString(),
                        fechaModificacion: new Date().toISOString(),
                        imagenEnvase: "",
                        imagenForma: ""
                    }
                ],
                medicamentosSeleccionados: [],
                planningData: {},
                planningTexts: {},
                nombrePaciente: "",
                datosHospital: {
                    nombre: "Nombre del hospital",
                    direccion: "Direcci√≥n completa",
                    telefono: "+34 XXX XXX XXX",
                    email: "contacto@hospital.es",
                    web: "https://www.hospital.es",
                    logo: "",
                    fechaCreacion: new Date().toISOString()
                }
            };

            const blob = new Blob([JSON.stringify(plantilla, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = 'plantilla_medicamentos.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function limpiarBaseDatos() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar toda la base de datos? Esta acci√≥n no se puede deshacer.')) {
                medicamentos = [];
                medicamentosSeleccionados = [];
                datosHospital = {};
                planningData = {};
                planningTexts = {};
                nombrePacienteActual = '';
                
                // Limpiar localStorage
                localStorage.removeItem('medicamentosDB_local');
                localStorage.removeItem('medicamentosSeleccionados_local');
                localStorage.removeItem('datosHospital_local');
                localStorage.removeItem('planningData_local');
                localStorage.removeItem('planningTexts_local');
                localStorage.removeItem('nombrePaciente_local');
                localStorage.removeItem('ultimoGuardado_local');
                localStorage.removeItem('ultimaDescarga_local');

                // Actualizar UI
                document.getElementById('formHospital').reset();
                document.getElementById('hospitalDisplayName').textContent = 'Hospital no configurado';
                actualizarDashboard();
                mostrarMedicamentosGestion();
                mostrarRepositorio();

                // Limpiar info del archivo
                document.getElementById('fileInfo').style.display = 'none';
                document.getElementById('dropZone').classList.remove('loaded');
                
                baseDatosRuta = null;
                actualizarEstadoBaseDatos('local');

                alert('‚úÖ Base de datos limpiada correctamente');
            }
        }

        function mostrarEstadisticas() {
            const estadisticasDiv = document.getElementById('estadisticasDB');
            
            if (estadisticasDiv.style.display === 'none') {
                const grupos = [...new Set(medicamentos.map(med => med.grupo))];
                const medicamentosConImagenes = medicamentos.filter(med => med.imagenEnvase || med.imagenForma).length;
                const medicamentosConPlanning = Object.keys(planningData).length;
                const totalHorariosConfigurados = Object.values(planningData).reduce((total, medData) => {
                    return total + Object.keys(medData).length;
                }, 0);
                const tama√±o = estimarTama√±oBaseDatos();
                
                const ultimaDescarga = localStorage.getItem('ultimaDescarga_local');
                const textoUltimaDescarga = ultimaDescarga ? new Date(ultimaDescarga).toLocaleString('es-ES') : 'Nunca';
                
                estadisticasDiv.innerHTML = `
                    <div class="alert alert-info">
                        <span>üìä</span>
                        <div>
                            <strong>Estad√≠sticas de la Base de Datos:</strong><br>
                            ‚Ä¢ Total de medicamentos: ${medicamentos.length}<br>
                            ‚Ä¢ Medicamentos con im√°genes: ${medicamentosConImagenes}<br>
                            ‚Ä¢ Grupos farmacol√≥gicos: ${grupos.length}<br>
                            ‚Ä¢ Tama√±o estimado: ${tama√±o}<br>
                            ‚Ä¢ Hospital configurado: ${datosHospital.nombre ? 'S√≠' : 'No'}<br>
                            ‚Ä¢ √öltima descarga: ${textoUltimaDescarga}<br>
                            ‚Ä¢ √öltima modificaci√≥n: ${localStorage.getItem('ultimoGuardado_local') ? new Date(localStorage.getItem('ultimoGuardado_local')).toLocaleString('es-ES') : 'Nunca'}
                        </div>
                    </div>
                `;
                estadisticasDiv.style.display = 'block';
            } else {
                estadisticasDiv.style.display = 'none';
            }
        }

        function estimarTama√±oBaseDatos() {
            const datos = {
                medicamentos: medicamentos,
                medicamentosSeleccionados: medicamentosSeleccionados,
                datosHospital: datosHospital,
                planningData: planningData,
                planningTexts: planningTexts,
                nombrePaciente: nombrePacienteActual
            };
            const jsonString = JSON.stringify(datos);
            const bytes = new Blob([jsonString]).size;
            
            if (bytes < 1024) return bytes + ' bytes';
            if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
            return Math.round(bytes / (1024 * 1024)) + ' MB';
        }

        // Funciones de UI
        function actualizarEstadoBaseDatos(tipo = 'local') {
            const statusElement = document.getElementById('dataStatus');
            
            switch(tipo) {
                case 'local':
                    statusElement.className = 'data-status status-local';
                    statusElement.innerHTML = '<span>üíæ</span> Base de datos local';
                    break;
                case 'external':
                    statusElement.className = 'data-status status-external';
                    statusElement.innerHTML = '<span>üìÅ</span> Archivo externo cargado';
                    break;
                case 'unsaved':
                    statusElement.className = 'data-status status-unsaved';
                    statusElement.innerHTML = '<span>‚ö†Ô∏è</span> Cambios sin guardar';
                    break;
            }
        }

        function cambiarPestana(tabId) {
            // Remover clase active de todas las pesta√±as
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));

            // Activar la pesta√±a seleccionada
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Actualizar contenido seg√∫n la pesta√±a
            switch(tabId) {
                case 'dashboard':
                    actualizarDashboard();
                    break;
                case 'gestion':
                    mostrarMedicamentosGestion();
                    break;
                case 'repositorio':
                    mostrarRepositorio();
                    break;
                case 'informacion':
                    mostrarInformacionPacientes();
                    break;
                case 'planning':
                    mostrarPlanning();
                    break;
                case 'informe':
                    generarInforme();
                    break;
            }
        }

        function actualizarDashboard() {
            document.getElementById('totalMedicamentos').textContent = medicamentos.length;
            
            const grupos = [...new Set(medicamentos.map(med => med.grupo))];
            document.getElementById('gruposPrincipales').textContent = grupos.length;
            
            actualizarUltimaDescarga();
        }

        function actualizarUltimaDescarga() {
            const ultimaDescarga = localStorage.getItem('ultimaDescarga_local');
            if (ultimaDescarga) {
                const fecha = new Date(ultimaDescarga);
                const fechaStr = fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                const horaStr = fecha.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('ultimaDescarga').innerHTML = `${fechaStr} <span style="font-weight: normal;">${horaStr}h</span>`;
            } else {
                document.getElementById('ultimaDescarga').textContent = '--';
            }
        }

        function generarId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Funciones de medicamentos
        function guardarMedicamento(event) {
            event.preventDefault();
            
            const datos = {
                nombre: document.getElementById('nombre').value,
                principioActivo: document.getElementById('principioActivo').value,
                grupo: document.getElementById('grupo').value,
                actividadFarmacologica: document.getElementById('actividadFarmacologica').value,
                formaAdministracion: document.getElementById('formaAdministracion').value,
                formaConservacion: document.getElementById('formaConservacion').value,
                lugarDispensacion: document.getElementById('lugarDispensacion').value,
                informacionImportante: document.getElementById('informacionImportante').value,
                fechaModificacion: new Date().toISOString(),
                imagenEnvase: document.getElementById('previewEnvase').src || '',
                imagenForma: document.getElementById('previewForma').src || ''
            };

            if (editandoId) {
                // Editar medicamento existente
                const index = medicamentos.findIndex(med => med.id === editandoId);
                if (index !== -1) {
                    medicamentos[index] = { ...medicamentos[index], ...datos };
                }
            } else {
                // A√±adir nuevo medicamento
                datos.id = generarId();
                datos.fechaCreacion = new Date().toISOString();
                medicamentos.push(datos);
            }

            guardarDatosLocales();
            cerrarModal();
            actualizarDashboard();
            mostrarMedicamentosGestion();
            mostrarRepositorio();
            mostrarIndicadorAutoguardado();

            alert(editandoId ? '‚úÖ Medicamento actualizado correctamente' : '‚úÖ Medicamento a√±adido correctamente');
        }

        function eliminarMedicamento(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este medicamento?')) {
                medicamentos = medicamentos.filter(med => med.id !== id);
                medicamentosSeleccionados = medicamentosSeleccionados.filter(selId => selId !== id);
                guardarDatosLocales();
                actualizarDashboard();
                mostrarMedicamentosGestion();
                mostrarRepositorio();
                mostrarIndicadorAutoguardado();
                alert('‚úÖ Medicamento eliminado correctamente');
            }
        }

        function mostrarMedicamentosGestion() {
            const tbody = document.querySelector('#tablaMedicamentosGestion tbody');
            
            if (medicamentos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üíä</div>
                            <h3>No hay medicamentos</h3>
                            <p>A√±ade tu primer medicamento o carga una base de datos</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const medicamentosOrdenados = [...medicamentos].sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));

            tbody.innerHTML = medicamentosOrdenados.map(med => `
                <tr>
                    <td class="medication-name-cell">${med.nombre}</td>
                    <td>${med.principioActivo}</td>
                    <td>
                        <span class="group-badge ${getGrupoClass(med.grupo)}">${med.grupo}</span>
                    </td>
                    <td>${med.lugarDispensacion}</td>
                    <td>${med.fechaModificacion ? new Date(med.fechaModificacion).toLocaleDateString('es-ES') : 'N/A'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-warning btn-sm" onclick="abrirModalMedicamento('${med.id}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarMedicamento('${med.id}')" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function mostrarRepositorio() {
            const container = document.getElementById('repositorioMedicamentos');
            
            if (medicamentos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>Repositorio vac√≠o</h3>
                        <p>A√±ade medicamentos desde la gesti√≥n o carga una base de datos</p>
                    </div>
                `;
                return;
            }

            const medicamentosOrdenados = [...medicamentos].sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));

            const html = medicamentosOrdenados.map(med => `
                <div class="card" style="margin-bottom: 15px; cursor: pointer; ${medicamentosSeleccionados.includes(med.id) ? 'border-color: #27ae60; background-color: rgba(39,174,96,0.05);' : ''}" 
                     onclick="toggleSeleccion('${med.id}')">
                    <div class="card-body" style="padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="checkbox" ${medicamentosSeleccionados.includes(med.id) ? 'checked' : ''} onchange="event.stopPropagation()">
                            <div style="flex: 1;">
                                <strong style="color: var(--text-secondary);">${med.nombre}</strong><br>
                                <span style="color: var(--text-light);">${med.principioActivo} - ${med.actividadFarmacologica}</span><br>
                                <span class="group-badge ${getGrupoClass(med.grupo)}" style="margin-top: 5px;">${med.grupo}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function toggleSeleccion(id) {
            if (medicamentosSeleccionados.includes(id)) {
                medicamentosSeleccionados = medicamentosSeleccionados.filter(selId => selId !== id);
            } else {
                medicamentosSeleccionados.push(id);
            }
            
            guardarDatosLocales();
            actualizarDashboard();
            mostrarRepositorio();
            debounceAutoSave();
        }

        function filtrarMedicamentosGestion() {
            const busqueda = document.getElementById('busquedaGestion').value.toLowerCase();
            const medicamentosFiltrados = medicamentos
                .filter(med => 
                    med.nombre.toLowerCase().includes(busqueda) ||
                    med.principioActivo.toLowerCase().includes(busqueda) ||
                    med.grupo.toLowerCase().includes(busqueda)
                )
                .sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
            
            const tbody = document.querySelector('#tablaMedicamentosGestion tbody');
            
            if (medicamentosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-light);">
                            No se encontraron medicamentos que coincidan con la b√∫squeda
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = medicamentosFiltrados.map(med => `
                <tr>
                    <td class="medication-name-cell">${med.nombre}</td>
                    <td>${med.principioActivo}</td>
                    <td>
                        <span class="group-badge ${getGrupoClass(med.grupo)}">${med.grupo}</span>
                    </td>
                    <td>${med.lugarDispensacion}</td>
                    <td>${med.fechaModificacion ? new Date(med.fechaModificacion).toLocaleDateString('es-ES') : 'N/A'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-warning btn-sm" onclick="abrirModalMedicamento('${med.id}')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarMedicamento('${med.id}')" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filtrarRepositorio() {
            const busqueda = document.getElementById('busquedaRepo').value.toLowerCase();
            const medicamentosFiltrados = medicamentos
                .filter(med => 
                    med.nombre.toLowerCase().includes(busqueda) ||
                    med.principioActivo.toLowerCase().includes(busqueda) ||
                    med.grupo.toLowerCase().includes(busqueda)
                )
                .sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
            
            const container = document.getElementById('repositorioMedicamentos');
            
            if (medicamentosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No se encontraron resultados</h3>
                        <p>No hay medicamentos que coincidan con la b√∫squeda</p>
                    </div>
                `;
                return;
            }

            const html = medicamentosFiltrados.map(med => `
                <div class="card" style="margin-bottom: 15px; cursor: pointer; ${medicamentosSeleccionados.includes(med.id) ? 'border-color: #27ae60; background-color: rgba(39,174,96,0.05);' : ''}" 
                     onclick="toggleSeleccion('${med.id}')">
                    <div class="card-body" style="padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="checkbox" ${medicamentosSeleccionados.includes(med.id) ? 'checked' : ''} onchange="event.stopPropagation()">
                            <div style="flex: 1;">
                                <strong style="color: var(--text-secondary);">${med.nombre}</strong><br>
                                <span style="color: var(--text-light);">${med.principioActivo} - ${med.actividadFarmacologica}</span><br>
                                <span class="group-badge ${getGrupoClass(med.grupo)}" style="margin-top: 5px;">${med.grupo}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Funciones de hospital
        function guardarDatosHospital(event) {
            event.preventDefault();
            
            datosHospital = {
                nombre: document.getElementById('hospitalNombre').value,
                direccion: document.getElementById('hospitalDireccion').value,
                telefono: document.getElementById('hospitalTelefono').value,
                email: document.getElementById('hospitalEmail').value,
                web: document.getElementById('hospitalWeb').value,
                logo: document.getElementById('previewLogo').src || '',
                fechaModificacion: new Date().toISOString()
            };

            guardarDatosLocales();
            actualizarDisplayHospital();
            mostrarIndicadorAutoguardado();
            alert('‚úÖ Datos del hospital guardados correctamente');
        }

        function cargarDatosHospitalForm() {
            if (Object.keys(datosHospital).length > 0) {
                document.getElementById('hospitalNombre').value = datosHospital.nombre || '';
                document.getElementById('hospitalDireccion').value = datosHospital.direccion || '';
                document.getElementById('hospitalTelefono').value = datosHospital.telefono || '';
                document.getElementById('hospitalEmail').value = datosHospital.email || '';
                document.getElementById('hospitalWeb').value = datosHospital.web || '';
                
                // Cargar logo si existe
                if (datosHospital.logo) {
                    const previewLogo = document.getElementById('previewLogo');
                    previewLogo.src = datosHospital.logo;
                    previewLogo.style.display = 'block';
                    previewLogo.parentElement.classList.add('has-image');
                }
            }
        }

        function actualizarDisplayHospital() {
            const displayElement = document.getElementById('hospitalDisplayName');
            
            if (datosHospital.nombre) {
                let contenido = '';
                
                // A√±adir logo si existe
                if (datosHospital.logo) {
                    contenido += `<img src="${datosHospital.logo}" class="hospital-logo" alt="Logo del hospital">`;
                }
                
                contenido += datosHospital.nombre;
                displayElement.innerHTML = contenido;
            } else {
                displayElement.textContent = 'Hospital no configurado';
            }
        }

        // Funciones de modal
        function abrirModalMedicamento(id = null) {
            editandoId = id;
            const modal = document.getElementById('modalMedicamento');
            const title = document.querySelector('.modal-title');
            
            if (id) {
                title.textContent = 'Editar Medicamento';
                const medicamento = medicamentos.find(med => med.id === id);
                if (medicamento) {
                    cargarDatosMedicamento(medicamento);
                }
            } else {
                title.textContent = 'A√±adir Medicamento';
                limpiarFormulario();
            }
            
            modal.classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('modalMedicamento').classList.remove('active');
            editandoId = null;
            limpiarFormulario();
        }

        function limpiarFormulario() {
            document.getElementById('formMedicamento').reset();
            document.getElementById('previewEnvase').style.display = 'none';
            document.getElementById('previewForma').style.display = 'none';
            
            // Limpiar las √°reas de upload
            document.querySelectorAll('.image-upload-area').forEach(area => {
                area.classList.remove('has-image');
            });
        }

        function cargarDatosMedicamento(medicamento) {
            document.getElementById('nombre').value = medicamento.nombre || '';
            document.getElementById('principioActivo').value = medicamento.principioActivo || '';
            document.getElementById('grupo').value = medicamento.grupo || '';
            document.getElementById('actividadFarmacologica').value = medicamento.actividadFarmacologica || '';
            document.getElementById('formaAdministracion').value = medicamento.formaAdministracion || '';
            document.getElementById('formaConservacion').value = medicamento.formaConservacion || '';
            document.getElementById('lugarDispensacion').value = medicamento.lugarDispensacion || '';
            document.getElementById('informacionImportante').value = medicamento.informacionImportante || '';
            
            // Cargar im√°genes si existen
            if (medicamento.imagenEnvase) {
                const previewEnvase = document.getElementById('previewEnvase');
                previewEnvase.src = medicamento.imagenEnvase;
                previewEnvase.style.display = 'block';
                previewEnvase.parentElement.classList.add('has-image');
            }

            if (medicamento.imagenForma) {
                const previewForma = document.getElementById('previewForma');
                previewForma.src = medicamento.imagenForma;
                previewForma.style.display = 'block';
                previewForma.parentElement.classList.add('has-image');
            }
        }

        function previewImage(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    input.parentElement.classList.add('has-image');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Funciones auxiliares
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô Modo Nocturno';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è Modo Diurno';
                localStorage.setItem('theme', 'dark');
            }
        }

        function cargarTemaGuardado() {
            const temaGuardado = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (temaGuardado === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è Modo Diurno';
            } else {
                themeToggle.textContent = 'üåô Modo Nocturno';
            }
        }

        function getGrupoClass(grupo) {
            switch(grupo.toLowerCase()) {
                case 'inmunosupresores':
                    return 'group-inmunosupresores';
                case 'antiinfecciosos':
                    return 'group-antiinfecciosos';
                default:
                    return 'group-otros';
            }
        }

        // Cerrar modales al hacer clic fuera de ellos
        setTimeout(() => {
            const modales = ['modalMedicamento', 'modalPaciente'];
            const funciones = [cerrarModal, cerrarModalPaciente];
            
            modales.forEach((modalId, index) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            funciones[index]();
                        }
                    });
                }
            });
        }, 100);

        // Funciones para Informaci√≥n de Pacientes
        function mostrarInformacionPacientes() {
            const container = document.getElementById('informacionPacientes');
            const medicamentosInfo = medicamentos
                .filter(med => medicamentosSeleccionados.includes(med.id))
                .sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
            
            if (medicamentosInfo.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No hay medicamentos seleccionados</h3>
                        <p>Selecciona medicamentos en el tratamiento para generar informaci√≥n para pacientes</p>
                    </div>
                `;
                return;
            }

            // Agrupar por tipo de medicamento
            const grupos = {};
            medicamentosInfo.forEach(med => {
                if (!grupos[med.grupo]) grupos[med.grupo] = [];
                grupos[med.grupo].push(med);
            });

            let html = '';
            Object.keys(grupos).forEach(grupo => {
                html += `
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header">${grupo}</div>
                        <div class="card-body">
                `;
                
                grupos[grupo].forEach(med => {
                    html += `
                        <div class="medication-card" style="margin-bottom: 20px;">
                            <div class="medication-name">${med.nombre}</div>
                            <span class="medication-group ${getGrupoClass(med.grupo)}">${med.grupo}</span>
                            
                            <div class="medication-details">
                                <div class="detail-item">
                                    <div class="detail-label">Principio activo</div>
                                    <div class="detail-content">${med.principioActivo}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">¬øC√≥mo tomar este medicamento?</div>
                                    <div class="detail-content">${med.formaAdministracion}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">¬øC√≥mo conservar este medicamento?</div>
                                    <div class="detail-content">${med.formaConservacion}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">¬øD√≥nde obtener este medicamento?</div>
                                    <div class="detail-content">${med.lugarDispensacion}</div>
                                </div>
                            </div>
                            
                            ${(med.imagenEnvase || med.imagenForma) ? `
                                <div class="medication-images">
                                    ${med.imagenEnvase ? `<img src="${med.imagenEnvase}" class="med-image-envase" alt="Envase de ${med.nombre}">` : ''}
                                    ${med.imagenForma ? `<img src="${med.imagenForma}" class="med-image-forma" alt="Forma farmac√©utica de ${med.nombre}">` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="important-info">
                                <span class="label">‚ö†Ô∏è Informaci√≥n importante:</span>
                                ${med.informacionImportante}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        // Funciones del Planning Horario
        function mostrarPlanning() {
            actualizarFechaPlanning();
            cargarNombrePacientePlanning();
            generarTablaPlanning();
        }

        function actualizarFechaPlanning() {
            const fecha = new Date();
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('planningDate').textContent = fecha.toLocaleDateString('es-ES', opciones);
        }

        function cargarNombrePacientePlanning() {
            document.getElementById('planningPatientName').value = nombrePacienteActual || '';
        }

        function generarTablaPlanning() {
            const container = document.getElementById('planningSchedule');
            const medicamentosInfo = medicamentos
                .filter(med => medicamentosSeleccionados.includes(med.id))
                .sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
            
            if (medicamentosInfo.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üïê</div>
                        <h3>No hay medicamentos seleccionados</h3>
                        <p>Selecciona medicamentos en el tratamiento para crear un planning horario</p>
                    </div>
                `;
                return;
            }

            // Generar horas del d√≠a
            const horas = Array.from({length: 24}, (_, i) => i);
            
            // Crear tabla
            let html = `
                <table class="time-schedule-table">
                    <thead>
                        <tr class="time-header">
                            <th style="width: 250px;">Medicamento</th>
            `;
            
            // Cabeceras de horas con iconos
            horas.forEach(hora => {
                let iconos = '';
                let bgClass = '';
                
                if (hora >= 6 && hora < 12) {
                    iconos = '<div class="time-icons"><span class="time-icon">‚òÄÔ∏è</span></div>';
                    bgClass = 'morning-bg';
                } else if (hora >= 12 && hora < 18) {
                    iconos = '<div class="time-icons"><span class="time-icon">üåû</span></div>';
                    bgClass = 'noon-bg';
                } else if (hora >= 18 && hora < 22) {
                    iconos = '<div class="time-icons"><span class="time-icon">üåÖ</span></div>';
                    bgClass = 'evening-bg';
                } else {
                    iconos = '<div class="time-icons"><span class="time-icon">üåô</span></div>';
                    bgClass = 'night-bg';
                }
                
                html += `
                    <th class="${bgClass}">
                        ${iconos}
                        <div class="hour-number">${hora.toString().padStart(2, '0')}</div>
                    </th>
                `;
            });
            
            html += '</tr></thead><tbody>';
            
            // Filas de medicamentos
            medicamentosInfo.forEach(med => {
                html += `<tr class="medication-row">`;
                
                // Columna de informaci√≥n del medicamento
                html += `
                    <td class="medication-info">
                        ${med.imagenEnvase ? `<img src="${med.imagenEnvase}" class="med-image-planning" alt="Envase de ${med.nombre}">` : '<div class="med-image-planning" style="background: var(--bg-primary); display: flex; align-items: center; justify-content: center; color: var(--text-light);">üíä</div>'}
                        <div class="med-name-planning">${med.nombre}</div>
                        <textarea class="med-planning-text" placeholder="Instrucciones espec√≠ficas..." 
                                  onchange="actualizarPlanningText('${med.id}', this.value)"
                                  oninput="autoResizeTextarea(this)">${planningTexts[med.id] || med.informacionPlanning || ''}</textarea>
                    </td>
                `;
                
                // Columnas de horas
                horas.forEach(hora => {
                    const isChecked = planningData[med.id] && planningData[med.id][hora] && planningData[med.id][hora].enabled;
                    const doseValue = isChecked ? (planningData[med.id][hora].dose || '1') : '';
                    
                    let bgClass = '';
                    if (hora >= 6 && hora < 12) bgClass = 'morning-bg';
                    else if (hora >= 12 && hora < 18) bgClass = 'noon-bg';
                    else if (hora >= 18 && hora < 22) bgClass = 'evening-bg';
                    else bgClass = 'night-bg';
                    
                    html += `
                        <td class="hour-cell ${bgClass}">
                            <div class="dose-container">
                                <input type="checkbox" class="dose-checkbox" 
                                       ${isChecked ? 'checked' : ''}
                                       onchange="toggleDosis('${med.id}', ${hora}, this.checked, this)">
                                <input type="text" class="dose-input" 
                                       placeholder="1" 
                                       value="${doseValue}"
                                       onchange="actualizarDosis('${med.id}', ${hora}, this.value)"
                                       ${!isChecked ? 'disabled' : ''}>
                                <span class="pill-icon">üíä</span>
                            </div>
                        </td>
                    `;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Auto-resize para todos los textareas
            setTimeout(() => {
                document.querySelectorAll('.med-planning-text').forEach(textarea => {
                    autoResizeTextarea(textarea);
                });
            }, 100);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(60, textarea.scrollHeight) + 'px';
        }

        function toggleDosis(medId, hora, checked, checkbox) {
            if (!planningData[medId]) {
                planningData[medId] = {};
            }
            
            if (checked) {
                planningData[medId][hora] = { 
                    enabled: true, 
                    dose: planningData[medId][hora]?.dose || '1' 
                };
            } else {
                delete planningData[medId][hora];
            }
            
            // Habilitar/deshabilitar el input de dosis
            const doseInput = checkbox.parentElement.querySelector('.dose-input');
            doseInput.disabled = !checked;
            if (!checked) {
                doseInput.value = '';
            } else if (!doseInput.value) {
                doseInput.value = '1';
            }
            
            guardarDatosLocales();
        }

        function actualizarDosis(medId, hora, dose) {
            if (!planningData[medId]) {
                planningData[medId] = {};
            }
            
            if (!planningData[medId][hora]) {
                planningData[medId][hora] = { enabled: true };
            }
            
            planningData[medId][hora].dose = dose.trim();
            guardarDatosLocales();
        }

        function actualizarPlanningText(medId, text) {
            planningTexts[medId] = text.trim();
            guardarDatosLocales();
        }

        function guardarPlanning() {
            // Guardar nombre del paciente
            nombrePacienteActual = document.getElementById('planningPatientName').value.trim();
            guardarDatosLocales();
            mostrarIndicadorAutoguardado();
            alert('‚úÖ Planning guardado correctamente');
        }

        function limpiarPlanning() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los horarios seleccionados?')) {
                planningData = {};
                guardarDatosLocales();
                generarTablaPlanning();
                mostrarIndicadorAutoguardado();
                alert('‚úÖ Horarios limpiados correctamente');
            }
        }

        // Funciones del Informe
        function generarInforme() {
            actualizarFechaInforme();
    
            // Actualizar informaci√≥n del hospital en el informe
            const hospitalInfoDiv = document.getElementById('hospitalInfoInforme');
            if (datosHospital.nombre) {
                let contenidoHospital = '';
        
                // A√±adir logo si existe
                if (datosHospital.logo) {
                    contenidoHospital += `<img src="${datosHospital.logo}" style="max-height: 35px; max-width: 140px; object-fit: contain; margin-bottom: 6px; display: block; margin-left: auto; margin-right: auto;" alt="Logo del hospital">`;
                }
        
                contenidoHospital += `
                    <h3 style="color: var(--text-secondary); margin-bottom: 3px; font-size: 15px;">${datosHospital.nombre}</h3>
                    ${datosHospital.direccion ? `<p style="color: var(--text-light); margin: 1px 0; font-size: 11px;">${datosHospital.direccion}</p>` : ''}
                    ${datosHospital.telefono ? `<p style="color: var(--text-light); margin: 1px 0; font-size: 11px;">Tel: ${datosHospital.telefono}</p>` : ''}
                    ${datosHospital.email ? `<p style="color: var(--text-light); margin: 1px 0; font-size: 11px;">Email: ${datosHospital.email}</p>` : ''}
                    ${datosHospital.web ? `<p style="color: var(--text-light); margin: 1px 0; font-size: 11px;">Web: ${datosHospital.web}</p>` : ''}
                `;
        
                hospitalInfoDiv.innerHTML = contenidoHospital;
            } else {
                hospitalInfoDiv.innerHTML = '<p style="color: var(--text-light); font-size: 11px;">Centro de salud</p>';
            }

            const container = document.getElementById('reporteMedicamentos');
            const medicamentosInfo = medicamentos
                .filter(med => medicamentosSeleccionados.includes(med.id))
                .sort((a, b) => a.nombre.localeCompare(b.nombre, 'es', { sensitivity: 'base' }));
    
            if (medicamentosInfo.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>No hay medicamentos para el informe</h3>
                        <p>Selecciona medicamentos en el tratamiento para generar el informe</p>
                    </div>
                `;
                return;
            }

            let html = '';
    
            // A√±adir nombre del paciente si est√° disponible
            if (nombrePacienteActual) {
                html += `
                    <div style="margin-bottom: 15px; padding: 12px; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-primary);">
                        <h3 style="color: var(--text-secondary); margin-bottom: 2px; font-size: 14px;">üë§ Paciente</h3>
                        <p style="color: var(--text-secondary); font-size: 15px; font-weight: 600; margin: 0;">${nombrePacienteActual}</p>
                    </div>
                `;
            }

            // Agregar consejos generales en la primera p√°gina (M√ÅS COMPACTOS)
            html += `
                <div style="margin-bottom: 20px; padding: 12px; background: var(--bg-primary); border-radius: 6px; border-left: 4px solid var(--accent-primary); page-break-after: always;">
                    <h3 style="color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">üí° Consejos Generales</h3>
                    <ul style="line-height: 1.4; margin: 0; padding-left: 16px; color: var(--text-primary); font-size: 14px;">
                        <li style="margin-bottom: 2px;">Tome los medicamentos seg√∫n las instrucciones de su m√©dico o farmac√©utico, respetando las dosis y horarios indicados</li>
                        <li style="margin-bottom: 2px;">Informe a su m√©dico sobre cualquier efecto secundario que experimente</li>
                        <li style="margin-bottom: 2px;">No interrumpa el tratamiento sin consultar con su m√©dico</li>
                        <li style="margin-bottom: 2px;">Conserve los medicamentos en lugar fresco y seco, lejos de la luz solar directa</li>
                        <li style="margin-bottom: 2px;">Mantenga los medicamentos fuera del alcance de los ni√±os</li>
                        <li style="margin-bottom: 2px;">Revise regularmente la fecha de caducidad de sus medicamentos</li>
                        <li style="margin-bottom: 2px;">Consulte con su m√©dico o farmac√©utico cualquier duda sobre sus medicamentos</li>
                        <li style="margin-bottom: 2px;">No comparta sus medicamentos con otras personas</li>
                    </ul>
                </div>
            `;
    
            html += '<div style="margin-bottom: 15px;"><h3 style="color: var(--text-secondary); font-size: 15px;">Medicamentos del Paciente</h3></div>';
    
            medicamentosInfo.forEach((med, index) => {
                // Generar escala horaria para este medicamento
                let horarioHtml = '';
                if (planningData[med.id] && Object.keys(planningData[med.id]).length > 0) {
                    horarioHtml = `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--accent-primary); page-break-inside: avoid;">
                            <h5 style="color: var(--text-secondary); margin-bottom: 6px; font-size: 12px;">üïí Horario de Administraci√≥n</h5>
                            <div style="display: flex; align-items: center; gap: 1px; flex-wrap: wrap;">
            `;
            
                    // Crear escala de 24 horas
                    for (let hora = 0; hora < 24; hora++) {
                        const tieneDosis = planningData[med.id][hora] && planningData[med.id][hora].enabled;
                        const dosis = tieneDosis ? (planningData[med.id][hora].dose || '1') : '';
                
                        // Determinar color de fondo seg√∫n momento del d√≠a
                        let bgColor = '#f5f5f5';
                        let textColor = '#999';
                        if (hora >= 6 && hora < 12) {
                            bgColor = tieneDosis ? '#fff9e6' : '#f8f8f8';
                        } else if (hora >= 12 && hora < 18) {
                            bgColor = tieneDosis ? '#fffacd' : '#f8f8f8';
                        } else if (hora >= 18 && hora < 22) {
                            bgColor = tieneDosis ? '#fff3cd' : '#f8f8f8';
                        } else {
                            bgColor = tieneDosis ? '#e6e6fa' : '#f8f8f8';
                        }
                
                        if (tieneDosis) {
                            textColor = '#000';
                            horarioHtml += `
                                <div style="
                                 min-width: 50px; 
                                    width: 50px;
                                    height: 50px; 
                                    background: ${bgColor}; 
                                    border: 2px solid #27ae60; 
                                    border-radius: 5px; 
                                    display: flex; 
                                    flex-direction: column; 
                                    align-items: center; 
                                    justify-content: center; 
                                    margin: 1px;
                                ">
                                    <div style="font-size: 9px; font-weight: bold; color: ${textColor}; margin-bottom: 1px;">${hora.toString().padStart(2, '0')}</div>
                                    <div style="display: flex; align-items: center; gap: 1px;">
                                        <span style="font-size: 14px; color: #27ae60; font-weight: bold;">${dosis || '1'}</span>
                                        <span style="font-size: 11px; color: #27ae60;">‚úÖ</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            horarioHtml += `
                                <div style="
                                    min-width: 30px; 
                                    width: 30px;
                                    height: 30px; 
                                    background: ${bgColor}; 
                                    border: 1px solid #ddd; 
                                    border-radius: 5px; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    margin: 1px;
                                ">
                                    <div style="font-size: 9px; color: ${textColor};">${hora.toString().padStart(2, '0')}</div>
                                </div>
                            `;
                        }
                    }
            
                    horarioHtml += `
                            </div>
                            <div style="margin-top: 5px; font-size: 9px; color: #666;">
                                <span style="margin-right: 10px;">‚úÖ = Toma programada (hora de administraci√≥n y unidades a administrar)</span>
                            </div>
                        </div>
                    `;
                }

                // Cada medicamento en p√°gina separada (excepto el primero)
                const pageBreakBefore = index > 0 ? 'page-break-before: always;' : '';
        
                html += `
                    <div style="padding: 15px; border: 1px solid var(--border-light); border-radius: 6px; page-break-inside: avoid; ${pageBreakBefore}">
                        <h4 style="color: var(--text-secondary); margin-bottom: 8px; font-size: 15px; page-break-after: avoid;">${med.nombre}</h4>
                        ${(med.imagenEnvase || med.imagenForma) ? `
                            <div style="margin-bottom: 10px; page-break-inside: avoid;">
                                ${med.imagenEnvase ? `<img src="${med.imagenEnvase}" style="width: 160px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid var(--border-color); margin-right: 10px; vertical-align: top;" alt="Envase de ${med.nombre}" title="Envase">` : ''}
                                ${med.imagenForma ? `<img src="${med.imagenForma}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid var(--border-color); vertical-align: top;" alt="Forma farmac√©utica de ${med.nombre}" title="Forma farmac√©utica">` : ''}
                            </div>
                        ` : ''}
                        ${horarioHtml}
                        <div style="page-break-inside: avoid;">
                            <p style="margin-bottom: 8px; font-size: 14px; page-break-inside: avoid;"><strong>Principio activo:</strong> ${med.principioActivo}</p>
                            <p style="margin-bottom: 8px; font-size: 14px; page-break-inside: avoid;"><strong>Grupo:</strong> ${med.grupo} - ${med.actividadFarmacologica}</p>
                            <p style="margin-bottom: 8px; font-size: 14px; page-break-inside: avoid;"><strong>Administraci√≥n:</strong> ${med.formaAdministracion}</p>
                            <p style="margin-bottom: 8px; font-size: 14px; page-break-inside: avoid;"><strong>Instrucciones espec√≠ficas:</strong> ${planningTexts[med.id] || ''}</p>
                            <p style="margin-bottom: 8px; font-size: 14px; page-break-inside: avoid;"><strong>Conservaci√≥n:</strong> ${med.formaConservacion}</p>
                            <p style="margin-bottom: 10px; font-size: 14px; page-break-inside: avoid;"><strong>Dispensaci√≥n:</strong> ${med.lugarDispensacion}</p>
                            <div style="background: rgba(230, 126, 34, 0.1); border-left: 4px solid #e67e22; padding: 10px; margin-top: 10px; page-break-inside: avoid;">
                                <strong style="font-size: 14px;">‚ö†Ô∏è Informaci√≥n importante:</strong> <span style="font-size: 14px;">${med.informacionImportante}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function actualizarFechaInforme() {
            const fecha = new Date();
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('fechaInforme').textContent = fecha.toLocaleDateString('es-ES', opciones);
        }

        function exportarPDF() {
            // Verificar que hay medicamentos seleccionados
            const medicamentosInfo = medicamentos.filter(med => medicamentosSeleccionados.includes(med.id));
            
            if (medicamentosInfo.length === 0) {
                alert('No hay medicamentos seleccionados para exportar');
                return;
            }
            
            // Abrir modal para introducir nombre del paciente
            abrirModalPaciente();
        }

        function abrirModalPaciente() {
            document.getElementById('nombrePaciente').value = nombrePacienteActual || '';
            document.getElementById('modalPaciente').classList.add('active');
        }

        function cerrarModalPaciente() {
            document.getElementById('modalPaciente').classList.remove('active');
        }

        function confirmarGenerarPDF() {
            nombrePacienteActual = document.getElementById('nombrePaciente').value.trim();
            cerrarModalPaciente();
            generarInforme(); // Regenerar el informe con el nombre del paciente
            realizarExportacionPDF();
        }

        function realizarExportacionPDF() {
            const elemento = document.getElementById('contenidoInforme');
            const nombreArchivo = nombrePacienteActual 
                ? `informe_${nombrePacienteActual.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`
                : `informe_medicamentos_${new Date().toISOString().split('T')[0]}.pdf`;
        
            const opciones = {
                margin: [15, 12, 20, 12],  // [top, left, bottom, right] - margen inferior mayor para numeraci√≥n
                filename: nombreArchivo,
                image: { 
                    type: 'jpeg', 
                    quality: 0.98 
                },
                html2canvas: { 
                    scale: 1.5,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'mm',
                    format: 'a4', 
                    orientation: 'landscape',
                    putOnlyUsedFonts: true
                },
                pagebreak: { 
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.page-break-before',
                    after: '.page-break-after',
                    avoid: '.page-break-inside-avoid'
                }
            };
    
            html2pdf().set(opciones).from(elemento).toPdf().get('pdf').then(function(pdf) {
                const totalPages = pdf.internal.getNumberOfPages();
        
                // A√±adir numeraci√≥n de p√°ginas
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(10);
                    pdf.setTextColor(128, 128, 128);
            
                    // Posici√≥n en la parte inferior derecha
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    pdf.text(`P√°gina ${i} de ${totalPages}`, pageWidth - 30, pdf.internal.pageSize.getHeight() - 10, {
                        align: 'right'
                    });
                }
        
                // Guardar el PDF
                pdf.save(nombreArchivo);
            }).catch((error) => {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Int√©ntelo de nuevo.');
            });
        }
    </script>
</body>
</html>